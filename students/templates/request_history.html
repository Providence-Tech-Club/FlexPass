{% extends 'base.html' %}
{% load tz %}

{% block title %}Request Log{% endblock %}

{% block content %}
<div class="grid w-7/8 md:w-2/3 xl:w-1/2">

  {% if user.student_user.active_request %}
  {% with request=user.student_user.active_request %}
  <ul class="list bg-base-300 rounded-box shadow-md mt-4">
    <li class="p-4 pb-2 text-lg tracking-wide flex">
      <h2 class="text-center self-center">Active Request</h2>
    </li>
    <div class="divider m-0"></div>

    <li class="list-row w-full">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor"
          class="self-center bi bi-envelope" viewBox="0 0 16 16">
          <path
            d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z" />
        </svg>
        <div class="truncate">
          <div>{{ request.destination }}</div>
          <div class="text-xs list-col-wrap font-semibold opacity-60">{{ request.reason }}</div>
        </div>

      <div class="list-col-grow flex justify-self-end gap-2">
        <div class="badge badge-soft badge-warning self-center truncate">Pending</div>
        <button class="btn btn-circle self-center" onclick="my_modal_{{ request.id }}.showModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
        </svg>
        </button>
      </div>
      <dialog id="my_modal_{{ request.id }}" class="modal">
        <div class="modal-box">
          <h3 class="text-lg">Request to <strong class="text-gold">{{ request.destination }}</strong></h3>

          <ul class="list">
            <li class="list-row">
              <div>
                <div>Requested on</div>
                <div class="text-xs uppercase font-semibold opacity-60">{{ request.created_at|localtime }}</div>
              </div>
            </li>
            <li class="list-row">
              <div>
                <div>Reason</div>
                <div class="text-xs font-semibold opacity-60">{{ request.reason }}</div>
              </div>
            </li>
          </ul>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Close</button>
            </form>
          </div>
        </div>
      </dialog>
    </li>
  </ul>
  {% endwith %}
  {% endif %}
  <ul class="list bg-base-300 rounded-box shadow-md mt-4">
    <li class="p-4 pb-2 text-lg tracking-wide grid grid-cols-2">
      <h2 class="text-center self-center justify-self-start">Request History</h2>
      <div class="mr-1 self-center justify-self-end badge badge-soft badge-primary">{{ request_history|length }}</div>
    </li>
    <div class="divider m-0"></div>

    {% for request in request_history %}
    <li class="list-row w-full">
        {% if request.approved %}
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="self-center bi bi-envelope-check" viewBox="0 0 16 16">
            <path d="M2 2a2 2 0 0 0-2 2v8.01A2 2 0 0 0 2 14h5.5a.5.5 0 0 0 0-1H2a1 1 0 0 1-.966-.741l5.64-3.471L8 9.583l7-4.2V8.5a.5.5 0 0 0 1 0V4a2 2 0 0 0-2-2zm3.708 6.208L1 11.105V5.383zM1 4.217V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v.217l-7 4.2z"/>
            <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0m-1.993-1.679a.5.5 0 0 0-.686.172l-1.17 1.95-.547-.547a.5.5 0 0 0-.708.708l.774.773a.75.75 0 0 0 1.174-.144l1.335-2.226a.5.5 0 0 0-.172-.686"/>
          </svg>
        {% else %}
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="self-center bi bi-envelope-x" viewBox="0 0 16 16">
            <path d="M2 2a2 2 0 0 0-2 2v8.01A2 2 0 0 0 2 14h5.5a.5.5 0 0 0 0-1H2a1 1 0 0 1-.966-.741l5.64-3.471L8 9.583l7-4.2V8.5a.5.5 0 0 0 1 0V4a2 2 0 0 0-2-2zm3.708 6.208L1 11.105V5.383zM1 4.217V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v.217l-7 4.2z"/>
            <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0m-4.854-1.354a.5.5 0 0 0 0 .708l.647.646-.647.646a.5.5 0 0 0 .708.708l.646-.647.646.647a.5.5 0 0 0 .708-.708l-.647-.646.647-.646a.5.5 0 0 0-.708-.708l-.646.647-.646-.647a.5.5 0 0 0-.708 0"/>
          </svg>
        {% endif %}
        <div class="truncate">
          <div>{{ request.destination }}</div>
          <p class="text-xs font-semibold opacity-60">{{ request.reason }}</p>
        </div>
      <div class="list-col-grow flex justify-self-end gap-2">
        <div class="self-center truncate">
          {% if request.approved %}
          <div class="badge badge-soft badge-success">Approved</div>
          {% else %}
          <div class="badge badge-soft badge-error">Denied</div>
          {% endif %}
        </div>
        <button class="btn btn-circle self-center" onclick="my_modal_{{ request.id }}.showModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
        </svg>
        </button>
      </div>
      <dialog id="my_modal_{{ request.id }}" class="modal">
        <div class="modal-box">
          <h3 class="text-lg">Request to <strong class="text-gold">{{ request.destination }}</strong></h3>

          <ul class="list">
            <li class="list-row">
              <div>
                <div>Requested on</div>
                <div class="text-xs uppercase font-semibold opacity-60">{{ request.created_at|localtime }}</div>
              </div>
            </li>
            <li class="list-row">
              <div>
                <div>Approved on</div>
                <div class="text-xs uppercase font-semibold opacity-60">{{ request.updated_at|localtime }}</div>
              </div>
            </li>
            <li class="list-row">
              <div>
                <div>Reason</div>
                <div class="text-xs font-semibold opacity-60">{{ request.reason }}</div>
              </div>
            </li>
          </ul>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Close</button>
            </form>
          </div>
        </div>
      </dialog>
    </li>
    {% endfor %}
  </ul>
</div>
<script>
const socket = new WebSocket('ws://' + window.location.host + '/ws/requests/');

socket.onmessage = function(e) {
    console.log("message received")
    const data = JSON.parse(e.data);
    console.log("Status changed:", data.status);
    
    // Simple approach: Refresh the whole page
    window.location.reload();
    
    // Advanced approach: Use HTMX or JS to update just the table row
};
</script>
{% endblock %}
